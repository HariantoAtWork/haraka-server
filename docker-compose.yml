version: '2'

services:
  certs:
    build: build/certs
    env_file: docker-compose.env
    volumes:
      - ./data/ssl:/etc/ssl

  haraka:
    build: build/haraka
    restart: unless-stopped
    ports:
      - '25:25'
      - '465:465'
      - '587:587'
    volumes:
      - ./data/haraka:/app/outbound
      - ./data/mail:/var/mail
      - ./data/ssl:/etc/ssl:ro
    volumes_from:
      - data

  postgres:
    build: build/postgres
    restart: unless-stopped
    env_file: docker-compose.env
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  dovecot:
    build: build/dovecot
    restart: unless-stopped
    env_file: docker-compose.env
    links:
      - postgres
    depends_on:
      - certs
      - postgres
    ports:
    # POP3
     - '110:110'
     - '995:995'
    # IMAP
     - '143:143'
     - '993:993'
    # SMTP SSL: Submission
    #  - '587:587'
    # LMTP
     - '24:24'
    # ManageSieve
     - '4190:4190'
    volumes:
      - ./data/mail:/var/mail
      - ./data/ssl:/etc/ssl:ro



  postgres-admin:
    image: adminer
    restart: unless-stopped
    env_file: docker-compose.env
    # ports:
    #  - '8080:8080'



  # haraka-db:
  #   image: couchdb:3
  #   environment:
  #     COUCHDB_USER: admin
  #     COUCHDB_PASSWORD: admin
  #   # ports:
  #   #   - '5984:5984'
  #   volumes:
  #     - ./haraka-db:/opt/couchdb/data

  # haraka-db:
  #   image: rethinkdb:2.4
  #   volumes:
  #     - ./haraka-db:/data
  #   # ports:
  #   #   - 28015
  #   #   - 29015
  #   #   - 8080

  data:
    image: node:10-alpine
    command: echo "Done."
    volumes:
      - ./data/tmp:/tmp

# create network: docker network create xnmp-network
networks:
  default:
    external:
      name: xnmp-network